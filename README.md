# Zengcode Kafka Retry/DLQ Starter

Spring Boot Starter ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Kafka ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ **Retry + Dead Letter Queue (DLQ)** ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥  
‚úÖ Plug-and-Play ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö `@KafkaListener` ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ  
‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡πÅ‡∏ö‡∏ö fixed ‡∏ï‡∏≤‡∏° `initial-interval-ms`  
‚úÖ ‡πÉ‡∏™‡πà header `x-retry-attempt` ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ retry  
‚úÖ ‡∏ï‡∏Å DLQ ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î

---

## ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á (‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô)

* ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô `@KafkaListener` ‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å **topic ‡∏´‡∏•‡∏±‡∏Å** ‡∏õ‡∏Å‡∏ï‡∏¥
* ‡∏ñ‡πâ‡∏≤ listener ‡πÇ‡∏¢‡∏ô exception:

   1. Starter ‡∏à‡∏∞ **publish ‡πÑ‡∏õ‡∏ó‡∏µ‡πà `<base>.retry`** ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏ö `x-retry-attempt` (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0)
   2. **Retry Bridge** (‡∏ó‡∏µ‡πà starter ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ) ‡∏à‡∏∞ consume ‡∏à‡∏≤‡∏Å `<base>.retry` ‚Üí **‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤**‡∏ï‡∏≤‡∏° `initial-interval-ms` ‚Üí **‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö** `<base>` ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° `x-retry-attempt` +1
   3. ‡∏ñ‡πâ‡∏≤ fail ‡∏ã‡πâ‡∏≥ ‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠ 1‚Äì2 ‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡∏à‡∏ô `x-retry-attempt + 1 >= max-attempts` ‚Üí **‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ `<base>.dlq`**

> ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ **fixed delay** ‡∏î‡πâ‡∏ß‡∏¢ `initial-interval-ms` (‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô). ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á `multiplier`/`max-interval-ms` ‡∏ñ‡∏π‡∏Å‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‚Äî‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö exponential ‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ

---

## ‡πÇ‡∏ü‡∏•‡∏ß‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°

```
<base> (‡πÄ‡∏ä‡πà‡∏ô orders)
  ‚îú‚îÄ ‚úÖ success ‚Üí done
  ‚îî‚îÄ ‚ùå fail ‚Üí <base>.retry
          (bridge: sleep initial-interval-ms ‚Üí ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö <base> ‡∏û‡∏£‡πâ‡∏≠‡∏° x-retry-attempt+1)
          ‚îî‚îÄ ‚ùå fail ‚Üí <base>.retry ‚Üí ... (‡∏ß‡∏ô‡∏à‡∏ô attempt ‡∏Ñ‡∏£‡∏ö)
                    ‚îî‚îÄ ‚ùå ‡∏Ñ‡∏£‡∏ö attempts ‚Üí <base>.dlq
```

* **‡πÑ‡∏°‡πà‡∏°‡∏µ** topic ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö `.retry.1000ms`, `.retry.2000ms` ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ
* ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 3 topics ‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á base:

   * `<base>` (‡πÄ‡∏ä‡πà‡∏ô `orders`)
   * `<base>.retry` (‡πÄ‡∏ä‡πà‡∏ô `orders.retry`)
   * `<base>.dlq` (‡πÄ‡∏ä‡πà‡∏ô `orders.dlq`)

---

## ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### 1) ‡πÄ‡∏û‡∏¥‡πà‡∏° properties (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)

```properties
# consumer ‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ
spring.kafka.consumer.group-id=app-consumer
spring.kafka.consumer.auto-offset-reset=earliest

# ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô byte[] ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏ï‡∏≤‡∏£‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö String ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á serializer/deserializer ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á)
spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.ByteArraySerializer
spring.kafka.producer.value-serializer=org.apache.kafka.common.serialization.ByteArraySerializer
spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.ByteArrayDeserializer
spring.kafka.consumer.value-deserializer=org.apache.kafka.common.serialization.ByteArrayDeserializer

# ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏ï‡∏≤‡∏£‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå
kafka.retry.enabled=true
kafka.retry.retry-suffix=.retry
kafka.retry.dlq-suffix=.dlq
kafka.retry.initial-interval-ms=1000     # ‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà 1s ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö base
kafka.retry.max-attempts=2               # ‡∏£‡∏ß‡∏° main+retry (0‚Üí1) ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏Å DLQ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô
```

> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: `max-attempts=2` = ‡∏•‡∏≠‡∏á‡∏ó‡∏µ‡πà main 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (attempt=0) ‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á ‚Üí ‡πÑ‡∏õ retry 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (attempt=1) ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏û‡∏±‡∏á ‚Üí DLQ

### 2) ‡∏™‡∏£‡πâ‡∏≤‡∏á topic (3 ‡∏≠‡∏±‡∏ô)

* `orders`
* `orders.retry`
* `orders.dlq`

‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ `KafkaAdmin`/`NewTopic` ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏π‡∏ï‡∏Å‡πá‡πÑ‡∏î‡πâ (‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö org ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)

### 3) ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô `@KafkaListener` ‡∏õ‡∏Å‡∏ï‡∏¥

```java
@KafkaListener(topics = "orders")
public void handle(byte[] message) {
  var text = new String(message, StandardCharsets.UTF_8);
  if (text.contains("FAIL")) {
    throw new RuntimeException("boom!");
  }
  // process success
}
```

**‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á**‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ErrorHandler ‡πÄ‡∏≠‡∏á, **‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á**‡πÑ‡∏õ subscribe `<base>.retry` ‡πÄ‡∏≠‡∏á
‡∏™‡∏ï‡∏≤‡∏£‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏∞‡∏ú‡∏π‡∏Å `DefaultErrorHandler` ‡πÅ‡∏•‡∏∞‡∏•‡∏á `Retry Bridge` ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

---

## Header ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á

* `x-retry-attempt` (string ‚Üí ‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢ retry)

   * main ‡∏•‡πâ‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‚Üí ‡πÇ‡∏î‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ `<base>.retry` ‡∏î‡πâ‡∏ß‡∏¢ `x-retry-attempt=0`
   * bridge ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö `<base>` ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 1, 2, ‚Ä¶
   * ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏Å `<base>.dlq` ‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ (debug/audit ‡πÑ‡∏î‡πâ)

> (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ header ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô exception class/message, message-id, first-failure-ts ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ)

---

## ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢

* **‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏ô client ‡∏°‡∏±‡πâ‡∏¢?**
  ‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á ‚Äî ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô listener ‡∏à‡∏≤‡∏Å `<base>` ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏° ‡∏™‡∏ï‡∏≤‡∏£‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ retry/dlq ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á

* **‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö String message ‡πÑ‡∏î‡πâ‡∏°‡∏±‡πâ‡∏¢?**
  ‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á serializer/deserializer ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏õ‡πá‡∏ô byte\[] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á)

* **‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏ó‡∏≥‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?**
  ‡∏ó‡∏≥‡∏ó‡∏µ‡πà **Retry Bridge** (‡∏ï‡∏±‡∏ß consumer ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏™‡∏ï‡∏≤‡∏£‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå) ‡πÇ‡∏î‡∏¢ `Thread.sleep(initial-interval-ms)` ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö `<base>`

---

‡πÅ‡∏Ñ‡πà‡∏ô‡∏µ‡πâ‡∏Å‡πá‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡∏î‡∏±‡∏Å‡∏ä‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏° client ‡πÑ‡∏õ‡∏ß‡∏∏‡πà‡∏ô‡∏Å‡∏±‡∏ö error handler ‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö üöÄ
